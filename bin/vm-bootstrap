#!/bin/bash

VM_RAM=512 # RAM in MiB
VM_SIZE=10 # HD size in GiB
VM_ARCH=amd64

DEBIAN_RELEASE=9
DEBIAN_RELEASE_NAME=stretch
DEBIAN_MIRROR=http://ftp.debian.org/debian
DEBIAN_PRESEED=$(dirname $(readlink -f $0))/preseed.cfg

if [  $# -ne 1 ]; then
	echo "Usage: $0 guest-name"
	exit 1
fi


DOMAIN=$(ansible-inventory --list | grep host_domain -m 1 | sed -e "s/.*\://g;s/[[:space:]]//g;s/[\",]//g")

virt-install \
	--nographics \
	--connect=qemu:///system \
	--name=${1} \
	--ram=$VM_RAM \
	--vcpus=1 \
	-l $DEBIAN_MIRROR/dists/$DEBIAN_RELEASE_NAME/main/installer-$VM_ARCH/ \
	--disk size=$VM_SIZE \
	--os-type=linux \
	--os-variant=debian$DEBIAN_RELEASE \
	--virt-type=kvm \
	--network bridge:ffhibr0 \
	--initrd-inject=$DEBIAN_PRESEED \
	--extra-args="auto=true priority=critical hostname=${1} domain=$DOMAIN console=ttyS0"

